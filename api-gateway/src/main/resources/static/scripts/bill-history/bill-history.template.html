<div class="bill-history-container">
    <h2 class="titleOwner">Bill History</h2>

    <div class="btn-toolbar mb-3 toolbar-gap" role="toolbar" aria-label="Bills toolbar">
        <div class="btn-group" role="group">
            <button class="btn btn-primary"
                    ng-class="{'active': $ctrl.toolbar.open==='search'}"
                    ng-click="$ctrl.togglePanel('search')">Search</button>
        </div>
        <div class="btn-group" role="group">
            <button class="btn btn-primary"
                    ng-class="{'active': $ctrl.toolbar.open==='filter'}"
                    ng-click="$ctrl.togglePanel('filter')">Filter</button>
        </div>
        <div class="btn-group" role="group">
            <a ui-sref="billNew" class="btn btn-success">New Bill</a>
        </div>
        <div class="btn-group" role="group">
            <button class="btn btn-outline-danger" ng-click="deleteAllBills()">Delete All Bills</button>
        </div>
    </div>

    <div class="card mb-3" ng-if="$ctrl.toolbar.open==='search'">
        <div class="card-body d-flex gap-2 flex-wrap">
            <input type="text" class="form-control" style="max-width:420px"
                   placeholder="Search bills…"
                   ng-model="$ctrl.searchQuery">
            <button class="btn btn-primary">Apply</button>
            <button class="btn btn-light" ng-click="$ctrl.searchQuery=''">Clear</button>
        </div>
    </div>

    <div class="card mb-3" ng-if="$ctrl.toolbar.open==='filter'">
        <div class="card-body">
            <h5 class="mb-3">Filter Bills</h5>
            <div class="d-flex flex-wrap align-items-end gap-3">
                <div class="form-group">
                    <label for="statusSel" class="form-label">Status</label>
                    <select id="statusSel" class="form-select" style="min-width: 160px"
                            ng-model="$ctrl.tempStatus">
                        <option value="">Any</option>
                        <option value="paid">Paid</option>
                        <option value="unpaid">Unpaid</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="yearSel" class="form-label">Year</label>
                    <select id="yearSel" class="form-select" style="min-width: 120px"
                            ng-model="$ctrl.tempYear">
                        <option value="">Any</option>
                        <option ng-repeat="y in $ctrl.availableYears" ng-value="y">{{y}}</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="visitSel" class="form-label">Visit Type</label>
                    <select id="visitSel" class="form-select" style="min-width: 180px"
                            ng-model="$ctrl.tempVisitType">
                        <option value="">Any</option>
                        <option value="regular">Regular</option>
                        <option value="emergency">Emergency</option>
                    </select>
                </div>

                <div class="ms-auto d-flex gap-2">
                    <button class="btn btn-primary" ng-click="$ctrl.applyFilter()">Apply</button>
                    <button class="btn btn-light" ng-click="$ctrl.resetFilter()">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <table class="table table-striped">
        <thead>
        <tr>
            <td>Bill Id</td>
            <td>Owner Name</td>
            <td>Owner Details</td>
            <td>Vet Name</td>
            <td>Visit Type</td>
            <td class="text-end">Amount</td>
            <td>Status</td>
            <td>Due Date</td>
            <td>Date</td>
            <td>Details</td>
            <td>Delete</td>
        </tr>
        </thead>
        <tbody>
        <tr ng-repeat="bill in ($ctrl.getRows() | filter: $ctrl.visitTypePredicate) track by $index">
            <td>{{bill.billId || bill.id}}</td>

            <td>{{ getCustomerDetails ? getCustomerDetails(bill.customerId) : (bill.owner || 'Unknown Owner') }}</td>

            <td>
                <a class="btn btn-sm btn-outline-secondary"
                   ui-sref="ownerDetails({ownerId: getOwnerUUIDByCustomerId ? getOwnerUUIDByCustomerId(bill.customerId) : bill.customerId})">
                    View Owner
                </a>
            </td>

            <td>{{ getVetDetails ? getVetDetails(bill.vetId) : (bill.vet || 'Unknown Vet') }}</td>

            <td>{{bill.visitType}}</td>
            <td class="text-end">{{bill.amount | currency}}</td>

            <td>
          <span class="badge"
                ng-class="{'bg-success': ($ctrl.activeStatus=='paid') || ((bill.status||'').toLowerCase()=='paid'),
                           'bg-secondary': ($ctrl.activeStatus=='unpaid') || ((bill.status||'').toLowerCase()=='unpaid'),
                           'bg-danger': ($ctrl.activeStatus=='overdue') || ((bill.status||'').toLowerCase()=='overdue')}">
            {{ ($ctrl.activeStatus || (bill.status || '')).toUpperCase() || '—' }}
          </span>
            </td>

            <td>{{bill.dueDate || bill.due}}</td>
            <td><code>{{bill.date}}</code></td>

            <td>
                <a class="btn btn-sm btn-outline-primary"
                   ui-sref="billDetails({billId: (bill.billId || bill.id)})">Details</a>
            </td>

            <td>
                <button class="btn btn-sm btn-outline-danger"
                        ng-click="deleteBill(bill.billId || bill.id)">Delete</button>
            </td>
        </tr>
        </tbody>
    </table>

    <div class="d-flex align-items-center gap-3">
        <button class="btn btn-light" ng-click="$ctrl.goPreviousPage()">« Prev</button>
        <span>Page {{$ctrl.page}} of {{$ctrl.totalPages}}</span>
        <button class="btn btn-light" ng-click="$ctrl.goNextPage()">Next »</button>
    </div>
</div>
